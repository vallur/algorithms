<!DOCTYPE html>
<html class="fuelux" lang="en">
  <head>
    <meta charset="utf-8">
    <title>Compression - what is the right API to use?</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="description" content="">
    <meta name="author" content="">
    <link href="http://fuelcdn.com/fuelux/2.2/css/fuelux.css" rel="stylesheet" /> 
	<link href="http://fuelcdn.com/fuelux/2.2/css/fuelux-responsive.css" rel="stylesheet" />
	<script src="http://ajax.googleapis.com/ajax/libs/jquery/1.8.2/jquery.min.js" type="text/javascript"></script>
	<script src="http://fuelcdn.com/fuelux/2.2/loader.min.js" type="text/javascript"></script>
    <link href="/css/docs.css" rel="stylesheet">
    <link href="/js/google-code-prettify/prettify.css" rel="stylesheet">	
	<link rel="shortcut icon" href="/favicon.ico">    
  </head>
  <body data-spy="scroll" data-target=".subnav" data-offset="50">
	<div class="navbar navbar-fixed-top">
  <div class="navbar-inner">
	<div class="container">
	  <a class="btn btn-navbar" data-toggle="collapse" data-target=".nav-collapse">
		<span class="icon-bar"></span>
		<span class="icon-bar"></span>
		<span class="icon-bar"></span>
	  </a>
	  <a class="brand" href="http://Vallur.github.com">Blog Dedicated for Banyan. Under Construction!</a>
	  <div class="nav-collapse">
		<ul class="nav">		  
		  <li class="">
			<a href="http://vallur.github.com"><i class="icon-home"></i> Home</a>
		  </li>
		  <li class="dropdown">
			<a href="#" class="dropdown-toggle" data-toggle="dropdown"><i class="icon-comment"></i> Social <b class="caret"></b></a>
				<ul class="dropdown-menu">										
					<li class=""><a href="http://github.com/banyan" rel="tooltip" title="Go to github.com/erjjones" target="_blank">GitHub</a></li>
					<li class=""><a href="http://www.linkedin.com/pub/vallur-narasimhan/5/219/570/" rel="tooltip" title="Go to LinkedIn profile" target="_blank">LinkedIn</a></li>										
				</ul>
			 </li>
		</ul>		
	  </div>
	</div>
  </div>
</div>
  
	<div class="container">	
		<div class="marketing">
		<div class="content">    
	<script src="https://apis.google.com/js/platform.js" async defer></script>
<script src="//platform.linkedin.com/in.js" type="text/javascript">lang: en_US</script>
<div id="fb-root"></div>
<script>(function(d, s, id) {
  var js, fjs = d.getElementsByTagName(s)[0];
  if (d.getElementById(id)) return;
  js = d.createElement(s); js.id = id;
  js.src = "//connect.facebook.net/en_US/sdk.js#xfbml=1&version=v2.0";
  fjs.parentNode.insertBefore(js, fjs);
}(document, 'script', 'facebook-jssdk'));</script>
<script type="text/javascript">
		/* * * CONFIGURATION VARIABLES: EDIT BEFORE PASTING INTO YOUR WEBPAGE * * */
		var disqus_shortname = 'vallur'; // required: replace example with your forum shortname
		var disqus_identifier = '/blog/CompressionMetrics';
		var disqus_url = 'http://vallur.github.com/blog/CompressionMetrics';

		/* * * DON'T EDIT BELOW THIS LINE * * */
		(function () {
			var s = document.createElement('script'); s.async = true;
			s.type = 'text/javascript';
			s.src = 'http://' + disqus_shortname + '.disqus.com/count.js';
			(document.getElementsByTagName('HEAD')[0] || document.getElementsByTagName('BODY')[0]).appendChild(s);
		}());
	</script>
<br/>
		<h1>Compression - what is the right API to use?</h1>
<br/>
<!--	<div class="span3 column">-->
		<strong>September  1, 2014 <small>.  <a href="http://vallur.github.com/blog/CompressionMetrics#disqus_thread" data-disqus-identifier="/blog/CompressionMetrics">Comments</a></small></strong>
		<br/><small>Tags:  <a href="/tags/java" title="View posts tagged with &quot;java&quot;"><u>java</u></a>     <a href="/tags/Compression" title="View posts tagged with &quot;Compression&quot;"><u>Compression</u></a>     <a href="/tags/SNAPI" title="View posts tagged with &quot;SNAPI&quot;"><u>SNAPI</u></a>     <a href="/tags/LZ4" title="View posts tagged with &quot;LZ4&quot;"><u>LZ4</u></a>     <a href="/tags/GZIP" title="View posts tagged with &quot;GZIP&quot;"><u>GZIP</u></a>     <a href="/tags/metrics" title="View posts tagged with &quot;metrics&quot;"><u>metrics</u></a>     <a href="/tags/ZLIB" title="View posts tagged with &quot;ZLIB&quot;"><u>ZLIB</u></a>    </small>
<!--	</div>		-->
<!--	<div class="span6 column">-->
		<p class="pull-right"> <a href="/blog/RightAPIToChooseForCall" title="Previous Post: Rest Over JSON or plain old sockets for communication"><i class="icon-chevron-left"></i></a> 	    </p>  
<!--	</div>-->
</div>
<!--<div class="row">-->&nbsp;<div class="g-plusone"></div><script type="IN/Share" data-counter="right"></script>&nbsp;<div class="fb-like" data-href="http://vallur.github.com/blog/CompressionMetrics" data-layout="button_count" data-action="like" data-show-faces="false" data-share="false"></div>&nbsp;<iframe class="github-btn" src="http://ghbtns.com/github-btn.html?user=vallur&repo=vallur.github.com&type=watch&count=true" allowtransparency="true" frameborder="0" scrolling="0" width="80px" height="20px"></iframe>&nbsp;<iframe class="github-btn" src="http://ghbtns.com/github-btn.html?user=vallur&repo=vallur.github.com&type=fork&count=true" allowtransparency="true" frameborder="0" scrolling="0" width="98px" height="20px"></iframe>
<!--</div>-->
<br/><hr>

    <p>Compression is used by a system to support many of the below advantages</p>

<ul>
<li>Send large packets over network faster.

<ul>
<li>When the communication link is slower the data can be sent faster as we will be sending less number of bytes.</li>
<li>Compression would be generally advantageous if request or response size is more than 1000 bytes, to reduce time spent on the network.</li>
</ul>
</li>
<li>When we are constrained by space data can be compressed and stored.</li>
<li>compression would also help while storing to a slow media.

<ul>
<li>We typicaly use SSD or HDD for storing data for long term storage which are 72 to 150+ times slower than temporary storage RAM. This is the reason why most high transactional systems are more memory bound.</li>
</ul>
</li>
</ul>


<p>Trying to compress and uncompress large number of bytes is counter productive so we would try to find a high bar and stick with that to understand the boundaries.</p>

<p>There are two flavors of famous compression algorithms</p>

<p>Huffman (Tree Based) - Inflate/Defelate, GZip
Lempel-ziv compression (Dictionary based) - LZ4, LZF, Snappy</p>

<p>Now for some metrics on the different code that can be used for compression and de-compression using different API. In the below examples we will be only looking at the fastest compression/de-compression with the different API available with their speed and size of compression.</p>

<p>GZip code -</p>

<script src="https://gist.github.com/vallur/dd9c25923548d0c3b4d1.js"></script>


<p>Snappy code -</p>

<script src="https://gist.github.com/vallur/0c0c552fd3e7f650570d.js"></script>


<p>LZF - ning compress code -</p>

<script src="https://gist.github.com/vallur/b693eb7fa1cb84b71995.js"></script>


<p>Deflator/Inflator code -</p>

<script src="https://gist.github.com/vallur/fa2b95100a51afa856d1.js"></script>


<p>LZ4 compression</p>

<script src="https://gist.github.com/vallur/a39ff248e98be4c1146c.js"></script>


<p>common code used by all the above API's -</p>

<script src="https://gist.github.com/vallur/6b33e8f2db1bbbf3f26a.js"></script>


<p>Let us see different performance and compression metrics of the different flavors listed above and their advantages</p>

<p>Below graph shows the size of compression for different compression algorithms.</p>

<p> <img src="/img/posts/compresssize.png" alt="compression size" /></p>

<p>Below graph shows the time taken in underseconds but displayed in milliseconds for un-compressing bytes based on the size</p>

<p> <img src="/img/posts/uncompresstime.png" alt="un-compression size" /></p>

<p>Below graph shows the time taken in underseconds but displayed in milliseconds for compression based on the size</p>

<p> <img src="/img/posts/compressiontime.png" alt="compression size" /></p>

<p>My experience on compression API is all the implementations that are stream based are too slow as they will have to use frequent allocation of memory bytes which results in frequent movement of bytes to resize arrays
hence too much wastage of memory as well as processing. It is always better to preallocate in the begining and then shrink the buffer if needed resulting in speed of processing.</p>

<p>total compression and uncompression time should be close to O(k) + O(n) + O(t)</p>

<ul>
<li>k&lt;n and t&lt;n</li>
<li>k is total size of compressed buffer</li>
<li>n is total size of uncompressed buffer</li>
<li>t is the total size of dictionary or repetitive values</li>
</ul>


<p>Compression using huffman algorithm is slow as it has to build the tree structure that represents the total buffer.</p>

<p>Based on the above metrics
The order of preference for compression based on size would be</p>

<ol>
<li>GZIP</li>
<li>Deflate/Inflate</li>
<li>Snappy</li>
<li>LZF</li>
<li>LZ4</li>
</ol>


<p>The order of preference for time taken for compression/decompression would be</p>

<ol>
<li>LZ4</li>
<li>Snappy</li>
<li>Deflate/Inflate</li>
<li>LZF</li>
<li>GZIP</li>
</ol>


<p>LZ4 is the clear winner when it comes to speed and next winner is deflate/inflate API when saving space.</p>

<p>We need to be careful while choosing Deflate/Inflate as we might not get the bang for while using a slow server, we may spend too much time on compression rather than network time if we use deflate/inflate compressions. Banyan can be configured to use LZ4, Snappy, Deflate/Inflate algorithms.</p>

<div class="row">   
    <div class="span9 column">
            <p class="pull-right"> <a href="/blog/RightAPIToChooseForCall" title="Previous Post: Rest Over JSON or plain old sockets for communication"><i class="icon-chevron-left"></i></a>       </p>  
    </div>
</div>




<p><div class="row"> <br/>
    <div class="span9 columns">  <br/>
        <h2>Comments Section</h2>
        <p>Feel free to comment on the post but keep it clean and on topic.</p>
        <div id="fb-root"></div>
<script>(function(d, s, id) {
  var js, fjs = d.getElementsByTagName(s)[0];
  if (d.getElementById(id)) return;
  js = d.createElement(s); js.id = id;
  js.src = "//connect.facebook.net/en_US/sdk.js#xfbml=1&amp;version=v2.0";
  fjs.parentNode.insertBefore(js, fjs);
}(document, 'script', 'facebook-jssdk'));</script>
<div class="fb-comments" data-href="http://vallur.github.io/blog/CompressionMetrics" data-numposts="5" data-width="700" data-colorscheme="light"></div>
</div></p>

<p><!-- Twitter -->
<script>!function(d,s,id){var js,fjs=d.getElementsByTagName(s)[0];if(!d.getElementById(id)){js=d.createElement(s);js.id=id;js.src="//platform.twitter.com/widgets.js";fjs.parentNode.insertBefore(js,fjs);}}(document,"script","twitter-wjs");</script></p>

<p><!-- Google + -->
<script type="text/javascript">
  (function() {
    var po = document.createElement('script'); po.type = 'text/javascript'; po.async = true;
    po.src = 'https://apis.google.com/js/plusone.js';
    var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(po, s);
  })();
</script></p>
		
</div>

		</div>		 
	 </div>   
	<div id="fb-root"></div>
<script>(function(d, s, id) {
  var js, fjs = d.getElementsByTagName(s)[0];
  if (d.getElementById(id)) return;
  js = d.createElement(s); js.id = id;
  js.src = "//connect.facebook.net/en_US/sdk.js#xfbml=1&version=v2.0";
  fjs.parentNode.insertBefore(js, fjs);
}(document, 'script', 'facebook-jssdk'));</script>
<script src="https://apis.google.com/js/platform.js" async defer></script>
<script src="//platform.linkedin.com/in.js" type="text/javascript">lang: en_US</script>
<footer class="footer">
  <div class="container">
<!--<div class="row">-->&nbsp;<div class="g-plusone"></div><script type="IN/Share" data-counter="right"></script>&nbsp;<div class="fb-like" data-href="http://vallur.github.com/blog/CompressionMetrics" data-layout="button_count" data-action="like" data-show-faces="false" data-share="false"></div>&nbsp;<iframe class="github-btn" src="http://ghbtns.com/github-btn.html?user=vallur&repo=vallur.github.com&type=watch&count=true" allowtransparency="true" frameborder="0" scrolling="0" width="80px" height="20px"></iframe>&nbsp;<iframe class="github-btn" src="http://ghbtns.com/github-btn.html?user=vallur&repo=vallur.github.com&type=fork&count=true" allowtransparency="true" frameborder="0" scrolling="0" width="98px" height="20px"></iframe>	<p class="pull-right"> <a href="/blog/RightAPIToChooseForCall" title="Previous Post: Rest Over JSON or plain old sockets for communication">&laquo; Previous Blog Post</a> 	  |  <a href="#">Back to top</a>  |   </p>        
	<p>Page last generated on October 15, 2014</p>
	<p>If need be, <a href="https://github.com/vallur/Feedback/issues/new" title="Leave feedback for Vallur"  target="_blank" >leave me some feedback</a>.</p>	
	<script>!function(d,s,id){var js,fjs=d.getElementsByTagName(s)[0];if(!d.getElementById(id)){js=d.createElement(s);js.id=id;js.src="//platform.twitter.com/widgets.js";fjs.parentNode.insertBefore(js,fjs);}}(document,"script","twitter-wjs");</script>	
	<script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

  ga('create', 'UA-53607051-1', 'auto');
  ga('send', 'pageview');

</script>
  </div>
</footer>

    <script type="text/javascript" src="http://platform.twitter.com/widgets.js"></script>    
    
	<script src="/js/custom.js" type="text/javascript"></script>	
	
	<script type="text/javascript">
		/* * * CONFIGURATION VARIABLES: EDIT BEFORE PASTING INTO YOUR WEBPAGE * * */
		var disqus_shortname = 'vallur'; // required: replace example with your forum shortname

		/* * * DON'T EDIT BELOW THIS LINE * * */
		(function () {
			var s = document.createElement('script'); s.async = true;
			s.type = 'text/javascript';
			s.src = 'http://' + disqus_shortname + '.disqus.com/count.js';
			(document.getElementsByTagName('HEAD')[0] || document.getElementsByTagName('BODY')[0]).appendChild(s);
		}());
	</script>
	
	<!-- Google Analytics -->
	<script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

  ga('create', 'UA-53607051-1', 'auto');
  ga('send', 'pageview');

</script>
  </body>
</html>
