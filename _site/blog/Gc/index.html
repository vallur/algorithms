<!DOCTYPE html>
<html class="fuelux" lang="en">
  <head>
    <meta charset="utf-8">
    <title>JVM options for performance and GC</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="description" content="">
    <meta name="author" content="">
    <link href="http://fuelcdn.com/fuelux/2.2/css/fuelux.css" rel="stylesheet" /> 
	<link href="http://fuelcdn.com/fuelux/2.2/css/fuelux-responsive.css" rel="stylesheet" />
	<script src="http://ajax.googleapis.com/ajax/libs/jquery/1.8.2/jquery.min.js" type="text/javascript"></script>
	<script src="http://fuelcdn.com/fuelux/2.2/loader.min.js" type="text/javascript"></script>
    <link href="/css/docs.css" rel="stylesheet">
    <link href="/js/google-code-prettify/prettify.css" rel="stylesheet">	
	<link rel="shortcut icon" href="/favicon.ico">    
  </head>
  <body data-spy="scroll" data-target=".subnav" data-offset="50">
	<div class="navbar navbar-fixed-top">
  <div class="navbar-inner">
	<div class="container">
	  <a class="btn btn-navbar" data-toggle="collapse" data-target=".nav-collapse">
		<span class="icon-bar"></span>
		<span class="icon-bar"></span>
		<span class="icon-bar"></span>
	  </a>
	  <a class="brand" href="http://Vallur.github.com">Blog Dedicated for Banyan. Under Construction!</a>
	  <div class="nav-collapse">
		<ul class="nav">		  
		  <li class="">
			<a href="http://vallur.github.com"><i class="icon-home"></i> Home</a>
		  </li>
		  <li class="dropdown">
			<a href="#" class="dropdown-toggle" data-toggle="dropdown"><i class="icon-comment"></i> Social <b class="caret"></b></a>
				<ul class="dropdown-menu">										
					<li class=""><a href="http://github.com/banyan" rel="tooltip" title="Go to github.com/erjjones" target="_blank">GitHub</a></li>
					<li class=""><a href="http://www.linkedin.com/pub/vallur-narasimhan/5/219/570/" rel="tooltip" title="Go to LinkedIn profile" target="_blank">LinkedIn</a></li>										
				</ul>
			 </li>
		</ul>		
	  </div>
	</div>
  </div>
</div>
  
	<div class="container">	
		<div class="marketing">
		<div class="content">    
	<script src="https://apis.google.com/js/platform.js" async defer></script>
<script src="//platform.linkedin.com/in.js" type="text/javascript">lang: en_US</script>
<div id="fb-root"></div>
<script>(function(d, s, id) {
  var js, fjs = d.getElementsByTagName(s)[0];
  if (d.getElementById(id)) return;
  js = d.createElement(s); js.id = id;
  js.src = "//connect.facebook.net/en_US/sdk.js#xfbml=1&version=v2.0";
  fjs.parentNode.insertBefore(js, fjs);
}(document, 'script', 'facebook-jssdk'));</script>
<script type="text/javascript">
		/* * * CONFIGURATION VARIABLES: EDIT BEFORE PASTING INTO YOUR WEBPAGE * * */
		var disqus_shortname = 'vallur'; // required: replace example with your forum shortname
		var disqus_identifier = '/blog/Gc';
		var disqus_url = 'http://vallur.github.com/blog/Gc';

		/* * * DON'T EDIT BELOW THIS LINE * * */
		(function () {
			var s = document.createElement('script'); s.async = true;
			s.type = 'text/javascript';
			s.src = 'http://' + disqus_shortname + '.disqus.com/count.js';
			(document.getElementsByTagName('HEAD')[0] || document.getElementsByTagName('BODY')[0]).appendChild(s);
		}());
	</script>
<br/>
		<h1>JVM options for performance and GC</h1>
<br/>
<!--	<div class="span3 column">-->
		<strong>August  8, 2014 <small>.  <a href="http://vallur.github.com/blog/Gc#disqus_thread" data-disqus-identifier="/blog/Gc">Comments</a></small></strong>
		<br/><small>Tags:  <a href="/tags/java," title="View posts tagged with &quot;java,&quot;"><u>java,</u></a>     <a href="/tags/GarbageCollection," title="View posts tagged with &quot;GarbageCollection,&quot;"><u>GarbageCollection,</u></a>     <a href="/tags/JVM" title="View posts tagged with &quot;JVM&quot;"><u>JVM</u></a>    </small>
<!--	</div>		-->
<!--	<div class="span6 column">-->
		<p class="pull-right"> <a href="/blog/Frequency-sum-average-mapreduce" title="Previous Post: Frequency, Sum, Average and Map Reduce with java 8"><i class="icon-chevron-left"></i></a> 	    	<a href="/blog/Security" title="Next Post: Handling security in Java"><i class="icon-chevron-right"></i></a> 	 </p>  
<!--	</div>-->
</div>
<!--<div class="row">-->&nbsp;<div class="g-plusone"></div><script type="IN/Share" data-counter="right"></script>&nbsp;<div class="fb-like" data-href="http://vallur.github.com/blog/Gc" data-layout="button_count" data-action="like" data-show-faces="false" data-share="false"></div>&nbsp;<iframe class="github-btn" src="http://ghbtns.com/github-btn.html?user=vallur&repo=vallur.github.com&type=watch&count=true" allowtransparency="true" frameborder="0" scrolling="0" width="80px" height="20px"></iframe>&nbsp;<iframe class="github-btn" src="http://ghbtns.com/github-btn.html?user=vallur&repo=vallur.github.com&type=fork&count=true" allowtransparency="true" frameborder="0" scrolling="0" width="98px" height="20px"></iframe>
<!--</div>-->
<br/><hr>

    <p>In this blog i will be talking about some of the JVM options that we can use for tuning performance and doing memory management.</p>

<p>When we want to set the memory ceiling for my java code i use the -Xms4m -Xmx4m option.  This says that the minimum and maximum memory used for my app is 4 MB.</p>

<script src="https://gist.github.com/vallur/0440b65454d7b3f1fdd2.js"></script>


<p>Code for SimpleThreadPool can be found here.</p>

<p>I wrote this code to see the behavior of GC with different options. With just this option <code>-Xms4m -Xmx4m</code> the memory foot print becomes like the below</p>

<p><img src="/img/posts/jvm1.png" alt="The Bad" /></p>

<p>with the option -XX:+UseConcMarkSweepGC option the image becomes like</p>

<p><img src="/img/posts/jvm4.png" alt="The Good" /></p>

<p>The difference is mostly like asking the kids to cleanup the mess at the end of the day vs immediately when they make it. The later is better while writing enterprise level applications to avoid stop the world garbage collectors. It is also preferable to write code that gives less garbage wherever it is possible topic for another time.</p>

<p>The effect on CPU and garbage without -XX:+UseConcMarkSweepGC is given below when we tweak the variable  <code>MEMORY_MIN_THRESHOLD=100;</code> instead of 3 and  set the vm option to <code>-Xms4000m -Xmx4000m</code>. Now I made the GC kicking and and spend more time in this case more than 37% of the CPU</p>

<p><img src="/img/posts/jvm3.png" alt="The UGLY" /></p>

<p>The high CPU is due to the locks caused by <code>LinkedBlockingQueue</code> trying to run the threads in a tight loop apart from the GC trying to free up memory. Don't do this in your code. and oh my god more than 90% CPU and the system is choking hard what do I do?.</p>

<p>I tried <code>-XX:+UseConcMarkSweepGC -XX:ConcGCThreads=4</code> and ran the application again i got the below result</p>

<p><img src="/img/posts/jvm2.png" alt="The UGLY" /></p>

<p>This is slightly better than the above but still bad due to the CPU spikes. The time on GC is less than 10% of CPU which is better than the previous result.</p>

<p>So i tried experimenting with  <code>-XX:+UseParallelGC -XX:MaxGCPauseMillis=1 -XX:ParallelGCThreads=4</code></p>

<p><img src="/img/posts/jvm5.png" alt="The UGLY" /></p>

<p>The GC is happening more frequently and the CPU spent on GC is less than 10% and total CPU spike is less than 50 % much better picture.</p>

<p>While write an application , releasing memory whenever done is a good practice and allocating them incrementally as need basis  -XX:+UseConcMarkSweepGC option will be our friend still may need to play around with -XX:ConcGCThreads=4 based on need and number of threads used.</p>

<p>If we are hogging up memory and releasing them like in the code above when the memory is almost full we have the option to use <code>-XX:+UseParallelGC -XX:MaxGCPauseMillis=1 -XX:ParallelGCThreads=4</code>.</p>

<p>There are other JVM options to tune like -XX:ThreadStackSize which can be tuned if we are writing a lot of recursive operations in our code. The full list of JVM options can be found <a href="http://www.oracle.com/technetwork/java/javase/tech/vmoptions-jsp-140102.html">here</a>. There are other options to fine tune the young and old generation memory space.</p>

<p>If we are writing code that requires more memory than the system actually has. It is always possible to allocate more during startup with the option <code>-Xms53000m -Xmx53000m</code>. I had tried to allocate close to 53GB on my MAC. It tries to allocate as much as possible and for the rest the OS does page faults and loads the items into memory opportunistically which would hinder performance. This helps in testing my long running code from home on my laptop.</p>

<p>As a general rule of thumb i tend to allocate 60% of the server memory for my server side code JVM and use 70%-80% of the memory that is allotted to the JVM to avoid things like stop the world GC.</p>

<p>There are other programming practices which can be done to avoid garbage and improve performance which we will cover separately.</p>

<p>The code sample given above is for learning the behavior of JVM only and should not be used as a defacto coding standard.</p>

<div class="row">   
    <div class="span9 column">
            <p class="pull-right"> <a href="/blog/Frequency-sum-average-mapreduce" title="Previous Post: Frequency, Sum, Average and Map Reduce with java 8"><i class="icon-chevron-left"></i></a>          <a href="/blog/Security" title="Next Post: Handling security in Java"><i class="icon-chevron-right"></i></a>     </p>  
    </div>
</div>




<p><div class="row"> <br/>
    <div class="span9 columns">  <br/>
        <h2>Comments Section</h2>
        <p>Feel free to comment on the post but keep it clean and on topic.</p>
        <div id="fb-root"></div>
<script>(function(d, s, id) {
  var js, fjs = d.getElementsByTagName(s)[0];
  if (d.getElementById(id)) return;
  js = d.createElement(s); js.id = id;
  js.src = "//connect.facebook.net/en_US/sdk.js#xfbml=1&amp;version=v2.0";
  fjs.parentNode.insertBefore(js, fjs);
}(document, 'script', 'facebook-jssdk'));</script>
<div class="fb-comments" data-href="http://vallur.github.io/blog/Gc" data-numposts="5" data-width="700" data-colorscheme="light"></div>
</div></p>

<p><!-- Twitter -->
<script>!function(d,s,id){var js,fjs=d.getElementsByTagName(s)[0];if(!d.getElementById(id)){js=d.createElement(s);js.id=id;js.src="//platform.twitter.com/widgets.js";fjs.parentNode.insertBefore(js,fjs);}}(document,"script","twitter-wjs");</script></p>

<p><!-- Google + -->
<script type="text/javascript">
  (function() {
    var po = document.createElement('script'); po.type = 'text/javascript'; po.async = true;
    po.src = 'https://apis.google.com/js/plusone.js';
    var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(po, s);
  })();
</script></p>
		
</div>

		</div>		 
	 </div>   
	<div id="fb-root"></div>
<script>(function(d, s, id) {
  var js, fjs = d.getElementsByTagName(s)[0];
  if (d.getElementById(id)) return;
  js = d.createElement(s); js.id = id;
  js.src = "//connect.facebook.net/en_US/sdk.js#xfbml=1&version=v2.0";
  fjs.parentNode.insertBefore(js, fjs);
}(document, 'script', 'facebook-jssdk'));</script>
<script src="https://apis.google.com/js/platform.js" async defer></script>
<script src="//platform.linkedin.com/in.js" type="text/javascript">lang: en_US</script>
<footer class="footer">
  <div class="container">
<!--<div class="row">-->&nbsp;<div class="g-plusone"></div><script type="IN/Share" data-counter="right"></script>&nbsp;<div class="fb-like" data-href="http://vallur.github.com/blog/Gc" data-layout="button_count" data-action="like" data-show-faces="false" data-share="false"></div>&nbsp;<iframe class="github-btn" src="http://ghbtns.com/github-btn.html?user=vallur&repo=vallur.github.com&type=watch&count=true" allowtransparency="true" frameborder="0" scrolling="0" width="80px" height="20px"></iframe>&nbsp;<iframe class="github-btn" src="http://ghbtns.com/github-btn.html?user=vallur&repo=vallur.github.com&type=fork&count=true" allowtransparency="true" frameborder="0" scrolling="0" width="98px" height="20px"></iframe>	<p class="pull-right"> <a href="/blog/Frequency-sum-average-mapreduce" title="Previous Post: Frequency, Sum, Average and Map Reduce with java 8">&laquo; Previous Blog Post</a> 	  |  <a href="#">Back to top</a>  |   	<a href="/blog/Security" title="Next Post: Handling security in Java">Next Blog Post &raquo; </a> 	 </p>        
	<p>Page last generated on October 15, 2014</p>
	<p>If need be, <a href="https://github.com/vallur/Feedback/issues/new" title="Leave feedback for Vallur"  target="_blank" >leave me some feedback</a>.</p>	
	<script>!function(d,s,id){var js,fjs=d.getElementsByTagName(s)[0];if(!d.getElementById(id)){js=d.createElement(s);js.id=id;js.src="//platform.twitter.com/widgets.js";fjs.parentNode.insertBefore(js,fjs);}}(document,"script","twitter-wjs");</script>	
	<script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

  ga('create', 'UA-53607051-1', 'auto');
  ga('send', 'pageview');

</script>
  </div>
</footer>

    <script type="text/javascript" src="http://platform.twitter.com/widgets.js"></script>    
    
	<script src="/js/custom.js" type="text/javascript"></script>	
	
	<script type="text/javascript">
		/* * * CONFIGURATION VARIABLES: EDIT BEFORE PASTING INTO YOUR WEBPAGE * * */
		var disqus_shortname = 'vallur'; // required: replace example with your forum shortname

		/* * * DON'T EDIT BELOW THIS LINE * * */
		(function () {
			var s = document.createElement('script'); s.async = true;
			s.type = 'text/javascript';
			s.src = 'http://' + disqus_shortname + '.disqus.com/count.js';
			(document.getElementsByTagName('HEAD')[0] || document.getElementsByTagName('BODY')[0]).appendChild(s);
		}());
	</script>
	
	<!-- Google Analytics -->
	<script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

  ga('create', 'UA-53607051-1', 'auto');
  ga('send', 'pageview');

</script>
  </body>
</html>
